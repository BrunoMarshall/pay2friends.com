<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Send Tokens</title>
  <link rel="icon" type="image/png" href="assets/Pay2Friends_Logo_Fox.png" />
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <header>
    <div class="header-container">
      <img src="assets/Pay2Friends_Logo_transparent.png" alt="Logo">
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="send-tokens.html">Send Tokens</a>
        <a id="connectBtn" onclick="connectWallet()">Log In</a>
        <div id="wallet-status" style="margin-top:5px; font-weight:bold; color:#f00; font-size:0.9rem;">
          ❌ Not connected
        </div>
      </nav>
    </div>
  </header>

  <main>
    <h1>Send Tokens</h1>
    <div class="wallet-info" id="walletCard">
      <h2>Wallet Information <span id="walletStatus" style="color: red;">● Not connected</span></h2>
      <button id="connectWallet" onclick="connectWallet()">Log In</button>
      <p id="walletAddress">Wallet: Not connected</p>
      <p id="walletBalance">Balance: 0 SHM / 0 P2F</p>
      <div class="email-register">
        <input type="email" id="emailInput" placeholder="Enter your email to register">
        <button type="button" id="registerEmailBtn" onclick="registerEmail()">Sign Up</button>
      </div>
      <div class="token-approval" style="margin-top: 15px;">
        <select id="tokenSelectApproval">
          <option value="0x0">SHM</option>
          <option value="0x30d16e2bd13bfdf42a47cc18468240bc3bed69ff">P2F</option>
        </select>
        <input type="number" id="approvalAmount" placeholder="Amount to approve">
        <button type="button" onclick="approveToken()">Approve Token</button>
      </div>
      <div class="token-deposit" style="margin-top: 15px;">
        <select id="tokenSelectDeposit">
          <option value="0x0">SHM</option>
          <option value="0x30d16e2bd13bfdf42a47cc18468240bc3bed69ff">P2F</option>
        </select>
        <input type="number" id="depositAmount" placeholder="Amount to deposit">
        <button type="button" onclick="depositTokens()">Deposit</button>
      </div>
    </div>

    <form class="send-form" id="sendForm">
      <label for="recipient">Recipient (Wallet Address or Email)</label>
      <input type="text" id="recipient" placeholder="0xABC... or example@email.com">
      <label for="tokenSelect">Token</label>
      <select id="tokenSelect">
        <option value="0x0">SHM</option>
        <option value="0x30d16e2bd13bfdf42a47cc18468240bc3bed69ff">P2F</option>
      </select>
      <label for="amount">Amount</label>
      <input type="number" id="amount" placeholder="Enter amount">
      <button type="button" id="sendBtn" onclick="sendTokens()">Send Tokens</button>
    </form>
    <div id="result"></div>
  </main>

  <footer>
    <p>Pay2Friends &copy; 2025</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="js/wallet.js"></script>
  <script>
    const contractAddress = "0x543d71889f984d36fc7d2b1fa019be4c5738ba6b";
    const tokenAddress = "0x30d16e2bd13bfdf42a47cc18468240bc3bed69ff";
    const contractABI = [
      {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "from", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "to", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "token", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "Transfer",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
          { "indexed": true, "internalType": "bytes32", "name": "emailHash", "type": "bytes32" }
        ],
        "name": "EmailRegistered",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
          { "indexed": true, "internalType": "bytes32", "name": "oldEmailHash", "type": "bytes32" },
          { "indexed": true, "internalType": "bytes32", "name": "newEmailHash", "type": "bytes32" }
        ],
        "name": "EmailUpdated",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "token", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "Deposit",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "token", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "Withdrawal",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "token", "type": "address" }
        ],
        "name": "TokenAdded",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "token", "type": "address" }
        ],
        "name": "TokenRemoved",
        "type": "event"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "token", "type": "address" }
        ],
        "name": "addToken",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "token", "type": "address" }
        ],
        "name": "removeToken",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "depositSHM",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "token", "type": "address" },
          { "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "depositToken",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "recipient", "type": "address" },
          { "internalType": "address", "name": "token", "type": "address" },
          { "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "transfer",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "account", "type": "address" },
          { "internalType": "address", "name": "token", "type": "address" }
        ],
        "name": "getBalance",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "token", "type": "address" },
          { "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "withdraw",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "string", "name": "email", "type": "string" }
        ],
        "name": "registerEmail",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "string", "name": "oldEmail", "type": "string" },
          { "internalType": "string", "name": "newEmail", "type": "string" }
        ],
        "name": "updateEmail",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "bytes32", "name": "emailHash", "type": "bytes32" }
        ],
        "name": "getAddressFromEmail",
        "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "", "type": "address" }
        ],
        "name": "supportedTokens",
        "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    const tokenABI = [
      {
        "inputs": [
          { "internalType": "address", "name": "spender", "type": "address" },
          { "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "approve",
        "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "account", "type": "address" }
        ],
        "name": "balanceOf",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    async function approveToken() {
      if (!provider || !signer) {
        document.getElementById("result").innerHTML = '<p style="color:red;">Please connect wallet first.</p>';
        return;
      }
      const token = document.getElementById("tokenSelectApproval").value;
      const amount = document.getElementById("approvalAmount").value;
      const resultDiv = document.getElementById("result");

      if (token === "0x0" || !amount || Number(amount) <= 0) {
        resultDiv.innerHTML = '<p style="color:red;">Select a valid token and amount.</p>';
        return;
      }

      try {
        const tokenContract = new ethers.Contract(token, tokenABI, signer);
        const amountWei = ethers.utils.parseUnits(amount, 18);
        const tx = await tokenContract.approve(contractAddress, amountWei);
        resultDiv.innerHTML = `<p style="color:blue;">⏳ Approving tokens... Tx: ${tx.hash}</p>`;
        await tx.wait();
        resultDiv.innerHTML = `<p style="color:green;">✅ Tokens approved!</p>`;
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }

    async function depositTokens() {
      if (!provider || !signer) {
        document.getElementById("result").innerHTML = '<p style="color:red;">Please connect wallet first.</p>';
        return;
      }
      const token = document.getElementById("tokenSelectDeposit").value;
      const amount = document.getElementById("depositAmount").value;
      const resultDiv = document.getElementById("result");

      if (!amount || Number(amount) <= 0) {
        resultDiv.innerHTML = '<p style="color:red;">Enter a valid amount.</p>';
        return;
      }

      try {
        const contract = new ethers.Contract(contractAddress, contractABI, signer);
        let tx;
        if (token === "0x0") {
          tx = await contract.depositSHM({ value: ethers.utils.parseEther(amount) });
        } else {
          tx = await contract.depositToken(token, ethers.utils.parseUnits(amount, 18));
        }
        resultDiv.innerHTML = `<p style="color:blue;">⏳ Depositing tokens... Tx: ${tx.hash}</p>`;
        await tx.wait();
        resultDiv.innerHTML = `<p style="color:green;">✅ Deposited ${amount} ${token === "0x0" ? "SHM" : "P2F"}</p>`;
        updateBalance();
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }

    async function sendTokens() {
      if (!provider || !signer) {
        document.getElementById("result").innerHTML = '<p style="color:red;">Please connect wallet first.</p>';
        return;
      }
      const recipientInput = document.getElementById("recipient").value.trim();
      const token = document.getElementById("tokenSelect").value;
      const amount = document.getElementById("amount").value;
      const resultDiv = document.getElementById("result");

      if (!recipientInput || !amount || Number(amount) <= 0) {
        resultDiv.innerHTML = '<p style="color:red;">Enter a valid recipient and amount.</p>';
        return;
      }

      try {
        const contract = new ethers.Contract(contractAddress, contractABI, signer);
        const amountWei = token === "0x0" ? ethers.utils.parseEther(amount) : ethers.utils.parseUnits(amount, 18);
        let tx;

        if (recipientInput.includes('@')) {
          const emailHash = ethers.utils.id(recipientInput.toLowerCase());
          const recipientAddress = await contract.getAddressFromEmail(emailHash);
          if (recipientAddress === ethers.constants.AddressZero) {
            resultDiv.innerHTML = `<p style="color:red;">Error: Email not registered.</p>`;
            return;
          }
          tx = await contract.transfer(recipientAddress, token, amountWei);
        } else {
          tx = await contract.transfer(recipientInput, token, amountWei);
        }

        resultDiv.innerHTML = `<p style="color:blue;">⏳ Transaction sent: ${tx.hash}</p>`;
        await tx.wait();
        resultDiv.innerHTML = `<p style="color:green;">✅ Sent ${amount} ${token === "0x0" ? "SHM" : "P2F"} to ${recipientInput}</p>`;
        updateBalance();
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }

      document.getElementById("recipient").value = '';
      document.getElementById("amount").value = '';
    }

    async function registerEmail() {
      if (!provider || !signer) {
        document.getElementById("result").innerHTML = '<p style="color:red;">Please connect wallet first.</p>';
        return;
      }
      const email = document.getElementById("emailInput").value.trim();
      const resultDiv = document.getElementById("result");
      if (!email) {
        resultDiv.innerHTML = '<p style="color:red;">Enter a valid email.</p>';
        return;
      }
      try {
        const contract = new ethers.Contract(contractAddress, contractABI, signer);
        const tx = await contract.registerEmail(email.toLowerCase());
        resultDiv.innerHTML = `<p style="color:blue;">⏳ Registering email... Tx: ${tx.hash}</p>`;
        await tx.wait();
        resultDiv.innerHTML = `<p style="color:green;">✅ Email registered successfully!</p>`;
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }
  </script>
</body>
</html>